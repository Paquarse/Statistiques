---
title: "TD1 SARIMA"
author: "Pâquarse Delvich Van Mahouvi"
date: "10/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr ::opts_chunk$set(comment=NA)
```

```{r}
library(xts)
library(readxl)
library(astsa)
library(ggfortify)
library(forecast)
library(fpp2)
```

#---------------------------------------------------------------------------------------
#!                           Exercice 1: Pure SARMA(P,D,Q)s                            !
#---------------------------------------------------------------------------------------
# Notice: sarima.sim(ar = NULL, d = 0, ma = NULL, sar = NULL, D = 0, sma = NULL, S = NULL, n = 500, ...)
         d (resp. D) order of difference (resp. seasonal difference), S seasonal period

# a) Generate 200 observations from a pure seasonal model given by X(t) = 0.9X(t-12) + e(t),
which we denote as a SARMA(1,0)_12. Call this sar1.

```{r}
sar1 <- sarima.sim(sar=0.9, S=12, n=200)
plot(sar1)
acf2(sar1, max.lag = 60)
```
Sur ce graphique, le 1 représente 12 mois à cause de la saisonnalité d'ordre. On voit donc que c'est significatif tous les 12 mois et est décroissant, c'est donc un AR saisonnier d'ordre 12

# b) Generate 200 observations from a pure seasonal model given by X(t) = e(t) + 0.8e(t-12),
#    which we denote as a SARMA(1,1)_12. Call this sma1.


```{r}
sma1 <- sarima.sim(sma=0.8, S=12, n=200)
plot(sma1)
acf2(sma1, max.lag = 60)
```
On remarque un seul pic significatif sur le ACF et plus rien. Il s'agit donc d'un MA saisonnier 

# c) Generate 200 observations from a pure seasonal model given by X(t) = 0.9X(t-12) + e(t) + 0.8e(t-12),
#    which we denote as a SARMA(1,1)_12. Call this sarma.
```{r}
sarma <- sarima.sim(sar=0.9, sma=0.8, S=12, n=200)
plot(sarma)
acf2(sarma, max.lag = 60)
```


# d) Fit the seasonal model "sarma" using sarima(). In addition to the p, d, and q arguments in 
#    your sarima() command, specify P, D, Q, and S (note that R is case sensitive).
```{r}
sarima(sarma, p = 0, d = 0, q = 0, P = 1, D = 0, Q = 1, S = 12)
```


#---------------------------------------------------------------------------------------
#!                     Exercice 2: Mixte ARIMA(p,d,q)xSARMA(P,D,Q)s                    !
#---------------------------------------------------------------------------------------
# Notice: as opposed to the pure seasonal model, there are correlations at the nonseasonal lags as well as the seasonal lags.

# a) Simulate data from a mixed seasonal model SARIMA(0,0,1)x(0,0,1)_12. Call it x.
Non saisonnière E(t), M1, Saisonnière : SMA(1)_12 
```{r}
x <- sarima.sim(ma = 0.4, sma = 0.5, S = 12, n = 200)
months = c("J","F","M","A","M","J","J","A","S","O","N","D")
plot(x[1:36],type='c')
points(x[1:36], pch=months, cex=1.1, font=4, col=1:4)
abline(v=c(1,13,25),lty=2)

```

# b) Plot the sample ACF/PACF to lag 60 (max.lag = 60) using acf2().
```{r}
acf2(x, max.lag = 60)
```


# c) Fit the model to generated data (x) using sarima().
```{r}
sarima(x, p = 0, d = 0, q = 1, P = 0, D = 0, Q = 1, S = 12)
```

Rappelle Cours : Etape de traitement: (Dans ce ordre, c'est la décomposition, en sens inverse 5 --> 1 c'est la recomposition )
1 - VAB
2 - CJO
3- CVS (SARMA Delta_X_t = Xt - Xt_-s a s l'ordre de stationnarité)
4 - log( Non stationnaire en variance )
5 - diff (Non stationnaire en moyenne)

On suppose ici que nous sommes a l'étape 3 (CVS) 
#---------------------------------------------------------------------------------------
#!                        Exercice 3: ARIMA with seasonal data                         !
#---------------------------------------------------------------------------------------
# ***************** I) Box-Jenkings with seasonal data ************************

Rappelle : La serie euretail est une serie trimestriel, donc on a 4 trimestres
```{r}
help(euretail) # Quarterly retail trade index in the Euro area (17 countries), 1996-2011
plot(euretail)
```


# a) Take the seasonal difference of the correct the seasonal pattern. Choose the order of the seasonal 
#    difference according to the frequency of the data. Use ggtsdisplay() to plot the data along with correlogram.
```{r}
ggtsdisplay(euretail)
```



# b) Take an additional first-difference to correct for non-stationnarity.
Sur la PACF, considéré le 4 comme etant 1
4 --> 1
8 --> 2
..
```{r}
euretail %>% diff(lag=4) %>% diff()%>%
  ggtsdisplay()
```



# c) Inspect the last correlogram and propose model candidates.
 Non-seasonnal lag: AR(1), MA(1), ARMA(1, 1)
 Seasonnal lag (S=4): SMA(1)_4, [SAR(1)_4, SARMA(1,1)_4]

# d) Fit different model canditates to euretail and check residuals.
# Notice: ARIMA(p,d,q)xSARMA(P,D,Q)s is fitted with Arima(order=c(p,d,q), seasonal=c(P,D,Q)) 
#         or Arima(order=c(p,d,q), seasonal=list(order=c(P,D,Q),period=s))

#    d1) Fit an ARIMA(1,1,0)xSARMA(1,1,0)4 model
Pour la partie saisonnalité, on va retenir le model SAR(1)_4 m<=> SARMA(1, 1, 0)4 avec D = 1 à cause de la difference saisonniere "diff(lag = 4)"

nul besoin de preciser que s = 4 (donnée trimestrielle), R le reconnait directement
Si dans la sortie, on n'a pas les t-stat les calcules, coeff/s.e. et comparé à 2

si coef/s.e. < 2, coefficient non significatif

```{r}
fit1 <- Arima(euretail, order=c(1,1,0), seasonal=c(1,1,0))
checkresiduals(fit1) #Ljung-Box test : p-value = 0.009 on ne rejette pas l'hypothèses nulle
ggtsdisplay(residuals(fit1)) #pacf 9 sort
summary(fit1) #coef ok AIC = 76.57
```
 

#    d2) Fit an ARIMA(0,1,1)xSARMA(0,1,1)4 model
```{r}
fit2 <- Arima(euretail, order=c(0,1,1), seasonal=c(0,1,1))
checkresiduals(fit2) # pb normalite, pb ACF(2)
ggtsdisplay(residuals(fit2)) #pb PACF(2)
summary(fit2) #coeff ok, AIC = 75.28
```


#    d3) Fit an ARIMA(1,1,1)xSARMA(1,1,1)4 model
```{r}
fit3 <- Arima(euretail, order=c(1, 1, 1), seasonal=c(1,1,1))
checkresiduals(fit3) #pb normalite, ACF ok
ggtsdisplay(residuals(fit3)) #pacf ok
summary(fit3) # coef non significatif (celui du sar1) (coef/s.e. < 2)
```
La fit3 n'est pas car les coefficients ne sont pas significatifs

#********************* II) auto.arima for seasonnal data *************************
# a) Use auto.arima to search for optimal model for euretail. Call it fit_auto.
```{r}
fit_auto <- auto.arima(euretail)
```


# b) Use summary() to summarize the final model that is retained.
```{r}
summary(fit_auto)
```
ARIMA(0,1,3)(0,1,1)[4] 
(0,1,1)[4] : SMA(1)_4

# c) Inspect residuals from that model.
```{r}
ggtsdisplay(residuals(fit_auto)) #ok
checkresiduals(fit_auto) #ok
```


#*************** III) Produce forecast using the best model *********************
# Recall the fitted model: fit1, fit2, fit3 and fit_auto
```{r}
fit_auto %>% forecast(h=12) %>% autoplot()
fit_auto %>% forecast(h=12) %>% summary()
```


#---------------------------------------------------------------------------------------
#!             Exercice 4: Additional exemple of ARIMA with seasonal data              !
#---------------------------------------------------------------------------------------

Revoir le TD sur la NS en variance notamment sur la transformation Box-Cox

```{r}
help(h02)
h02 %>% autoplot()
```


# a) Check that the logged h02 data have stable variance
```{r}
h02 %>% log() %>% autoplot()
```


# b) Fit a seasonal ARIMA model to h02 using auto.arima() with lambda = 0
Il fait la décomposition et la recomposition direct

```{r}
fit_h02 <- auto.arima(h02, lambda = 0)
```


# c) Summarize the fitted model
Detection : ARIMA(2,1,1)(0,1,2)[12]
RU : 1
ARMA(2, 1)
SMA(2)4
```{r}
summary(fit_h02)
```


# d) Inspect residuals from that model.

```{r}
ggtsdisplay(residuals(fit_h02))
checkresiduals(fit_h02)
```

# e) Plot 2-year forecasts
```{r}
fit_h02 %>% forecast(h=24) %>% autoplot()
```


# f) Forecast from snaive() function might be used as a comparison, namely by using test set and tsCV.
```{r}
h02 %>% snaive() %>% forecast(h=24) %>% autoplot()
```


